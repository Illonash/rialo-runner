<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rialo Skater</title>
  <style>
    html, body { margin:0; height:100%; background:#0b0b0b; overflow:hidden; }
    #game-root { width:100vw; height:100vh; }
    * { box-sizing: border-box; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
</head>
<body>
  <div id="game-root"></div>

<script>
// ===============================================
// RIALO SKATER (Single Character + City Parallax)
// Scenes: Boot -> Splash -> Menu -> Game -> GameOver
// Scale: 16:9 FIT (fullscreen adaptif)
// Controls: Space/Tap = Jump, ArrowDown/SwipeDown = Slide
// Leaderboard: localStorage (Top 10)
// ===============================================

const GAME_WIDTH  = 1280;
const GAME_HEIGHT = 720;

const STORAGE_KEY = 'rialo_skater_leaderboard_v1';
const FRAME_W = 128; // skater_girl per frame
const FRAME_H = 128;

const G = { sfx:{}, map:'city' };

// ---------- Leaderboard (local) ----------
const Leaderboard = {
  load() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; } },
  save(rows) { localStorage.setItem(STORAGE_KEY, JSON.stringify(rows.slice(0,10))); },
  push(name, score) { const r=this.load(); r.push({name,score,ts:Date.now()}); r.sort((a,b)=>b.score-a.score); this.save(r); return r; }
};

// ---------------- Boot ----------------
class BootScene extends Phaser.Scene {
  constructor(){ super('boot'); }
  preload(){
    // Karakter (9 frame, 1 baris, 128x128)
    this.load.spritesheet('skater', 'assets/skater_girl.png?v=1', {
      frameWidth: FRAME_W, frameHeight: FRAME_H
    });

    // Character preview (opsional)
    this.load.image('char_preview', 'assets/char_skater_preview.png?v=1');

    // Splash (opsional, 16:9)
    this.load.image('splash_bg', 'assets/splash_16x9.png?v=1');

    // Map City: preview + 6 layer parallax
    this.load.image('map_city_preview', 'assets/maps/city/map_city_preview.png?v=1');
    for (let i=1; i<=6; i++){
      this.load.image('city'+i, `assets/maps/city/city${i}.png?v=1`);
    }

    // Audio (opsional)
    this.load.audio('bgm_city',   'assets/audio/bgm_city.mp3');
    this.load.audio('sfx_jump',   'assets/audio/jump.wav');
    this.load.audio('sfx_collect','assets/audio/collect.wav');
    this.load.audio('sfx_hit',    'assets/audio/hit.wav');
  }
  create(){ this.scene.start('splash'); }
}

// ---------------- Splash ----------------
class SplashScene extends Phaser.Scene {
  constructor(){ super('splash'); }
  create(){
    const cx=GAME_WIDTH/2, cy=GAME_HEIGHT/2;

    if (this.textures.exists('splash_bg')) {
      const bg = this.add.image(cx, cy, 'splash_bg').setOrigin(0.5);
      const s = Math.max(GAME_WIDTH/bg.width, GAME_HEIGHT/bg.height);
      (bg.width && bg.height) ? bg.setScale(s) :
        bg.setPosition(0,0).setOrigin(0,0).setDisplaySize(GAME_WIDTH, GAME_HEIGHT);
    } else {
      this.cameras.main.setBackgroundColor('#0e0e0e');
      this.add.text(cx, cy-60, 'Rialo Skater', { fontFamily:'system-ui', fontSize: 48, fontStyle:'bold', color:'#fff' }).setOrigin(0.5);
      this.add.text(cx, cy-16, 'Rethink · Rebuild · Rialo', { fontFamily:'system-ui', fontSize: 20, color:'#a7a7a7' }).setOrigin(0.5);
    }

    const btn=this.add.rectangle(cx, cy+200, 240, 64, 0xFFC62E).setInteractive({useHandCursor:true});
    this.add.text(btn.x, btn.y, 'PLAY', { fontFamily:'system-ui', fontSize:28, color:'#111', fontStyle:'bold' }).setOrigin(0.5);
    btn.on('pointerup', ()=> this.scene.start('menu'));

    const fs=this.add.text(GAME_WIDTH-16,12,'⛶',{fontFamily:'system-ui',fontSize:22,color:'#fff'}).setOrigin(1,0).setInteractive({useHandCursor:true});
    fs.on('pointerup', ()=> this.scale.isFullscreen ? this.scale.stopFullscreen() : this.scale.startFullscreen());
  }
}

// ---------------- Menu (center + previews) ----------------
class MenuScene extends Phaser.Scene {
  constructor(){ super('menu'); }
  create(){
    this.cameras.main.setBackgroundColor('#0f1216');
    const cx = GAME_WIDTH/2;

    const back = this.add.text(24, 18, '← Back', { fontFamily:'system-ui', fontSize:18, color:'#9aa4b2' })
      .setInteractive({ useHandCursor:true }).setScrollFactor(0);
    back.on('pointerup', ()=> this.scene.start('splash'));

    let y = 90;
    this.add.text(cx, y, 'Select Character', {
      fontFamily:'system-ui', fontSize: 34, color:'#ffffff', fontStyle:'bold'
    }).setOrigin(0.5);

    // Character card
    y += 190;
    const cardW = 380, cardH = 420;
    this.add.rectangle(cx, y, cardW, cardH, 0x12161c).setStrokeStyle(2, 0x2c3440);

    if (this.textures.exists('char_preview')) {
      const pv = this.add.image(cx, y-40, 'char_preview').setOrigin(0.5);
      const scale = Math.min(220/pv.width, 220/pv.height);
      pv.setScale(scale*1.2);
    } else {
      const thumb = this.add.sprite(cx, y-40, 'skater', 1).setScale(1.6);
      thumb.setCrop(0,0,FRAME_W,FRAME_H);
      if (!this.anims.exists('menu_run')) {
        this.anims.create({
          key: 'menu_run',
          frames: this.anims.generateFrameNumbers('skater', { start: 1, end: 4 }),
          frameRate: 8, repeat: -1
        });
      }
      thumb.play('menu_run');
    }

    this.add.text(cx, y+cardH/2-36, 'Skater Girl', {
      fontFamily:'system-ui', fontSize: 22, color:'#ffffff'
    }).setOrigin(0.5);
    this.add.rectangle(cx, y, cardW+4, cardH+4).setStrokeStyle(4, 0x35e1a1);

    // Map section
    y += cardH/2 + 70;
    this.add.text(cx, y, 'Select Map', {
      fontFamily:'system-ui', fontSize: 30, color:'#ffffff', fontStyle:'bold'
    }).setOrigin(0.5);

    y += 190;
    const mapW = 640, mapH = 360;
    this.add.rectangle(cx, y, mapW, mapH, 0x12161c).setStrokeStyle(2, 0x2c3440);
    if (this.textures.exists('map_city_preview')) {
      const pv = this.add.image(cx, y, 'map_city_preview').setOrigin(0.5);
      const s = Math.min(mapW/pv.width, mapH/pv.height);
      pv.setScale(s);
    } else {
      const ph = this.add.graphics();
      ph.fillStyle(0x1a2330, 1).fillRoundedRect(cx - mapW/2 + 8, y - mapH/2 + 8, mapW-16, mapH-16, 12);
      this.add.text(cx, y, 'City (preview)', { fontFamily:'system-ui', fontSize: 22, color:'#9fb8ff' }).setOrigin(0.5);
    }

    const btnY = Math.min(GAME_HEIGHT - 70, y + mapH/2 + 50);
    const startBtn = this.add.rectangle(cx, btnY, 240, 64, 0x35e1a1).setInteractive({useHandCursor:true});
    this.add.text(startBtn.x, startBtn.y, 'SKATE!', { fontFamily:'system-ui', fontSize:26, color:'#111', fontStyle:'bold'}).setOrigin(0.5);
    startBtn.on('pointerup', ()=> this.scene.start('game'));

    this.input.keyboard.on('keydown', (e) => {
      if (e.code === 'Enter' || e.code === 'Space') this.scene.start('game');
    });
  }
}

// ---------------- Game (parallax city + runner) ----------------
class GameScene extends Phaser.Scene {
  constructor(){ super('game'); }
  create(){
    // Parallax with 6 layers (tileSprite)
    // urut dari paling belakang ke depan
    const speeds = [0.15, 0.25, 0.5, 0.9, 1.3, 1.8];
    this.parallax = [];
    for (let i=1;i<=6;i++){
      const key = 'city'+i;
      const ts = this.add.tileSprite(0, 0, GAME_WIDTH, GAME_HEIGHT, key).setOrigin(0,0);
      ts.setScrollFactor(0);
      // if source image has different height, center it vertically:
      const tex = this.textures.get(key).getSourceImage();
      if (tex && tex.height && tex.height !== GAME_HEIGHT) {
        // stretch cover while preserving aspect horizontally
        const scale = Math.max(GAME_WIDTH/tex.width, GAME_HEIGHT/tex.height);
        ts.setTileScale(scale, scale);
      }
      this.parallax.push({ ts, speed: speeds[i-1] });
    }

    this.physics.world.setBounds(0, 0, Number.MAX_SAFE_INTEGER/4, GAME_HEIGHT);
    this.groundY = GAME_HEIGHT - 90;

    // Player
    this.player = this.physics.add.sprite(220, this.groundY-60, 'skater', 0).setScale(1.2);
    this.player.setCollideWorldBounds(true);
    this.player.setSize(this.player.width*0.45, this.player.height*0.75, true);
    this.player.setOffset(this.player.width*0.27, this.player.height*0.2);

    // Animations (0 idle; 1-4 run; 5-7 jump; 8 crash)
    this.anims.create({ key:'idle',  frames:[{key:'skater',frame:0}], frameRate:1,  repeat:-1 });
    this.anims.create({ key:'run',   frames:this.anims.generateFrameNumbers('skater',{start:1,end:4}), frameRate:12, repeat:-1 });
    this.anims.create({ key:'jump',  frames:this.anims.generateFrameNumbers('skater',{start:5,end:7}), frameRate:10, repeat:0 });
    this.anims.create({ key:'crash', frames:[{key:'skater',frame:8}], frameRate:1, repeat:0 });
    this.player.play('run');

    // Input
    this.cursors = this.input.keyboard.createCursorKeys();
    let touchStartY=null;
    this.input.on('pointerdown', p=> touchStartY=p.y);
    this.input.on('pointerup', p=>{
      if (touchStartY===null) return;
      const dy=p.y-touchStartY;
      if (Math.abs(dy)<30){
        if (this.player.body.onFloor()){
          this.jump();
        }
      } else if (dy>30){
        if (this.player.body.onFloor()){ this.isSliding=true; }
      }
      touchStartY=null;
    });

    // Audio
    G.sfx.jump    = this.sound.add('sfx_jump',   {volume:.6});
    G.sfx.collect = this.sound.add('sfx_collect',{volume:.6});
    G.sfx.hit     = this.sound.add('sfx_hit',    {volume:.7});
    this.bgm = this.sound.add('bgm_city',{loop:true,volume:.35});
    if (this.bgm && this.bgm.key!=='__MISSING') this.bgm.play();

    // Score
    this.score=0;
    this.scoreText=this.add.text(20,20,'Score: 0',{fontFamily:'system-ui',fontSize:24,color:'#fff'}).setScrollFactor(0);

    // Spawners (pakai physics group sederhana)
    this.obstacles = this.physics.add.group();
    this.gems = this.physics.add.group();
    this.physics.add.collider(this.player, this.obstacles, this.onHit, null, this);
    this.time.addEvent({ delay:1200, loop:true, callback:()=> this.spawnObstacle(this.groundY) });
    this.time.addEvent({ delay:900,  loop:true, callback:()=> this.spawnGem(this.groundY) });

    // After jump anim finish
    this.player.on('animationcomplete', (anim)=>{
      if (anim.key==='jump' && this.player.body.onFloor()) this.player.play('run', true);
    });

    this.baseSpeed = 260; // player forward velocity
  }

  jump(){
    this.player.setVelocityY(-520);
    this.player.play('jump', true);
    G.sfx.jump?.play?.();
    this.isSliding=false;
  }

  update(){
    // Player forward push (untuk sensasi maju)
    this.player.setVelocityX(this.baseSpeed);

    // Parallax scroll
    this.parallax.forEach(l => l.ts.tilePositionX += l.speed);

    // Keyboard jump/slide
    if (Phaser.Input.Keyboard.JustDown(this.cursors.space) && this.player.body.onFloor()){
      this.jump();
    }
    if (this.cursors.down.isDown && this.player.body.onFloor()){
      this.isSliding = true; // (placeholder; anim slide belum dibuat di spritesheet)
    } else if (this.player.body.onFloor() && !this.player.anims.isPlaying){
      this.player.play('run', true); this.isSliding=false;
    }

    // Collect gems
    this.physics.overlap(this.player, this.gems, (player, gem)=>{
      gem.destroy(); this.score += 10;
      this.scoreText.setText('Score: '+this.score);
      G.sfx.collect?.play?.();
    });
  }

  spawnObstacle(groundY){
    const high = Math.random()<0.5 ? false : true;
    const y = high ? (groundY-90) : (groundY-40);
    const w = high ? 140 : 50;
    const h = high ? 30  : 60;
    const color = high? 0xE3C833 : 0xD94848;
    const x = GAME_WIDTH + 80;
    const rect = this.add.rectangle(x, y, w, h, color).setOrigin(0.5);
    this.physics.add.existing(rect);
    rect.body.setVelocityX(-this.baseSpeed);
    rect.body.setAllowGravity(false);
    this.obstacles.add(rect);
  }

  spawnGem(groundY){
    const y = groundY - 120 - Math.random()*120;
    const x = GAME_WIDTH + 80;
    const circ=this.add.circle(x, y, 12, 0x35e1a1);
    this.physics.add.existing(circ);
    circ.body.setVelocityX(-this.baseSpeed);
    circ.body.setAllowGravity(false);
    this.gems.add(circ);
  }

  onHit(){
    if (this.gameOver) return; this.gameOver=true;
    G.sfx.hit?.play?.();
    this.player.play('crash', true); this.player.setVelocity(0);
    this.time.delayedCall(900, ()=>{ this.scene.start('gameover',{score:this.score}); this.sound.stopAll(); });
  }
}

// ---------------- Game Over ----------------
class GameOverScene extends Phaser.Scene {
  constructor(){ super('gameover'); }
  init(data){ this.finalScore = data.score || 0; }
  create(){
    this.cameras.main.setBackgroundColor('#101010');
    const cx=GAME_WIDTH/2, cy=GAME_HEIGHT/2;

    this.add.text(cx, cy-120,'Game Over',{fontFamily:'system-ui',fontSize:54,color:'#fff',fontStyle:'bold'}).setOrigin(0.5);
    this.add.text(cx, cy-60,`Score: ${this.finalScore}`,{fontFamily:'system-ui',fontSize:28,color:'#fff'}).setOrigin(0.5);

    const raw = prompt('Masukkan nama untuk leaderboard:', localStorage.getItem('rr_name')||'player');
    const name=(raw||'player').slice(0,14); localStorage.setItem('rr_name', name);
    const rows=Leaderboard.push(name, this.finalScore);

    this.add.text(cx, cy+10, 'Leaderboard (Local)', {fontFamily:'system-ui',fontSize:22,color:'#a7a7a7'}).setOrigin(0.5);
    const startY=cy+40;
    rows.slice(0,10).forEach((r,i)=>{
      const y=startY+i*26; const hi=(r.name===name && r.score===this.finalScore); const color=hi?'#35e1a1':'#ffffff';
      this.add.text(cx-140,y,String(i+1).padStart(2,'0'),{fontFamily:'monospace',fontSize:18,color}).setOrigin(0,0.5);
      this.add.text(cx-90, y, r.name.slice(0,14),        {fontFamily:'system-ui',fontSize:18,color}).setOrigin(0,0.5);
      this.add.text(cx+160,y,r.score.toString(),         {fontFamily:'system-ui',fontSize:18,color}).setOrigin(1,0.5);
    });

    const playAgain=this.add.rectangle(cx-100,GAME_HEIGHT-80,200,56,0x35e1a1).setInteractive({useHandCursor:true});
    this.add.text(playAgain.x,playAgain.y,'PLAY AGAIN',{fontFamily:'system-ui',fontSize:20,color:'#111',fontStyle:'bold'}).setOrigin(0.5);
    playAgain.on('pointerup',()=> this.scene.start('game'));

    const mainMenu=this.add.rectangle(cx+160,GAME_HEIGHT-80,200,56,0xFFC62E).setInteractive({useHandCursor:true});
    this.add.text(mainMenu.x,mainMenu.y,'MAIN MENU',{fontFamily:'system-ui',fontSize:20,color:'#111',fontStyle:'bold'}).setOrigin(0.5);
    mainMenu.on('pointerup',()=> this.scene.start('menu'));

    const resetBtn=this.add.text(40,GAME_HEIGHT-50,'Reset Leaderboard',{fontFamily:'system-ui',fontSize:16,color:'#aaa'}).setInteractive({useHandCursor:true});
    resetBtn.on('pointerup',()=>{ localStorage.removeItem(STORAGE_KEY); this.scene.restart({score:this.finalScore}); });
  }
}

// ---------------- Config ----------------
const config = {
  type: Phaser.AUTO,
  parent: 'game-root',
  backgroundColor: '#000000',
  scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: GAME_WIDTH, height: GAME_HEIGHT },
  physics: { default: 'arcade', arcade: { gravity: { y: 1200 }, debug: false } },
  scene: [BootScene, SplashScene, MenuScene, GameScene, GameOverScene],
};

new Phaser.Game(config);
</script>
</body>
</html>
