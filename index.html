<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rialo Skater</title>
  <style>
    html,body{margin:0;height:100%;background:#0b0b0b;overflow:hidden}
    #game-root{width:100vw;height:100vh}
    *{box-sizing:border-box}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
</head>
<body>
<div id="game-root"></div>
<script>
// ======= CONFIG =======
const GAME_WIDTH=1280, GAME_HEIGHT=720;
const STORAGE_KEY='rialo_skater_leaderboard_v1';

// ======= GLOBAL =======
const G={map:'city', sfx:{}};

// ======= LEADERBOARD =======
const Leaderboard={
  load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[]}catch{ return[]}},
  save(rows){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows.slice(0,10)))},
  push(name,score){const r=this.load(); r.push({name,score,ts:Date.now()}); r.sort((a,b)=>b.score-a.score); this.save(r); return r;}
};

// ======= BOOT =======
class BootScene extends Phaser.Scene{
  constructor(){super('boot')}
  preload(){
    // karakter
    this.load.spritesheet('skater','assets/skater_girl.png?v=3',{frameWidth:128,frameHeight:128});
    this.load.image('char_skater_preview','assets/char_skater_preview.png?v=3');

    // splash (opsional)
    this.load.image('splash_bg','assets/splash_16x9.png?v=3');

    // map city: preview + 6 layer parallax
    this.load.image('map_city_preview','assets/maps/city/map_city_preview.png?v=3');
    for(let i=1;i<=6;i++) this.load.image('city'+i,`assets/maps/city/city${i}.png?v=3`);
  }
  create(){ this.scene.start('splash') }
}

// ======= SPLASH =======
class SplashScene extends Phaser.Scene{
  constructor(){super('splash')}
  create(){
    const cx=GAME_WIDTH/2, cy=GAME_HEIGHT/2;
    const tex=this.textures.get('splash_bg')?.getSourceImage();
    if(tex && tex.width){
      const bg=this.add.image(cx,cy,'splash_bg').setOrigin(0.5);
      const s=Math.max(GAME_WIDTH/tex.width,GAME_HEIGHT/tex.height); bg.setScale(s);
    }else{
      this.cameras.main.setBackgroundColor('#0e0e0e');
      this.add.text(cx,cy-60,'Rialo Skater',{fontFamily:'system-ui',fontSize:48,fontStyle:'bold',color:'#fff'}).setOrigin(0.5);
      this.add.text(cx,cy-16,'Rethink · Rebuild · Rialo',{fontFamily:'system-ui',fontSize:20,color:'#a7a7a7'}).setOrigin(0.5);
    }
    const btn=this.add.rectangle(cx,cy+200,240,64,0xFFC62E).setInteractive({useHandCursor:true});
    this.add.text(btn.x,btn.y,'PLAY',{fontFamily:'system-ui',fontSize:28,color:'#111',fontStyle:'bold'}).setOrigin(0.5);
    btn.on('pointerup',()=>this.scene.start('menu'));

    const fs=this.add.text(GAME_WIDTH-16,12,'⛶',{fontFamily:'system-ui',fontSize:22,color:'#fff'}).setOrigin(1,0).setInteractive({useHandCursor:true});
    fs.on('pointerup',()=> this.scale.isFullscreen?this.scale.stopFullscreen():this.scale.startFullscreen());
  }
}

// ======= MENU (2 columns, smaller previews, no "Select ..." headings) =======
class MenuScene extends Phaser.Scene{
  constructor(){super('menu')}
  create(){
    this.cameras.main.setBackgroundColor('#0f1216');
    const F='system-ui';
    this.ui={};

    // Back
    this.ui.back=this.add.text(24,18,'← Back',{fontFamily:F,fontSize:18,color:'#9aa4b2'})
      .setInteractive({useHandCursor:true}).on('pointerup',()=>this.scene.start('splash'));

    // (hapus "Select Map/Character"); gunakan label spesifik saja
    this.ui.mapLabel = this.add.text(0,0,'City',{fontFamily:F,fontSize:24,color:'#ffffff'}).setOrigin(0.5,1);
    this.ui.charLabel= this.add.text(0,0,'Skater Girl',{fontFamily:F,fontSize:24,color:'#ffffff'}).setOrigin(0.5,1);

    // Map (left)
    this.ui.mapFrame=this.add.rectangle(0,0,560,315,0x12161c).setStrokeStyle(2,0x2c3440);
    if(this.textures.exists('map_city_preview')){
      this.ui.mapImage=this.add.image(0,0,'map_city_preview').setOrigin(0.5);
    }else{
      this.ui.mapImage=this.add.graphics(); this.ui.mapImage.fillStyle(0x1a2330,1).fillRoundedRect(-260,-145,520,290,12);
    }

    // Character (right)
    this.ui.charFrame=this.add.rectangle(0,0,420,460,0x12161c).setStrokeStyle(2,0x2c3440);
    if(this.textures.exists('char_skater_preview')){
      this.ui.charImg=this.add.image(0,0,'char_skater_preview').setOrigin(0.5); this.ui.charIsSprite=false;
    }else{
      this.ui.charImg=this.add.sprite(0,0,'skater',1).setOrigin(0.5); this.ui.charIsSprite=true;
      if(!this.anims.exists('menu_run')){
        this.anims.create({key:'menu_run',frames:this.anims.generateFrameNumbers('skater',{start:1,end:4}),frameRate:8,repeat:-1});
      }
      this.ui.charImg.play('menu_run');
    }
    this.ui.charHL=this.add.rectangle(0,0,424,464).setStrokeStyle(4,0x35e1a1);

    // Start (beri jarak nyaman dari panel)
    this.ui.startBtn=this.add.rectangle(0,0,260,64,0x35e1a1).setInteractive({useHandCursor:true});
    this.ui.startLbl=this.add.text(0,0,'SKATE!',{fontFamily:F,fontSize:26,color:'#111',fontStyle:'bold'}).setOrigin(0.5);
    this.ui.startBtn.on('pointerup',()=>this.scene.start('game'));
    this.input.keyboard.on('keydown',e=>{ if(e.code==='Enter'||e.code==='Space') this.scene.start('game') });

    this.relayout();
    this.scale.on('resize',()=>this.relayout());
  }

  relayout(){
    const W=this.scale.gameSize.width||GAME_WIDTH;
    const H=this.scale.gameSize.height||GAME_HEIGHT;
    const cx=W/2;

    // grid & ukuran (lebih kecil dari sebelumnya)
    const marginX=Math.max(28,W*0.04);
    const gapCol =Math.max(28,W*0.04);
    const topPad =60;
    const labelGap=12;
    const btnGap =56; // jarak tombol dari panel

    // kolom lebih ramping supaya preview kecil
    let colW=(W - marginX*2 - gapCol)/2;
    colW=Math.min(colW, 580); // batasi

    const stack=W<980;
    if(stack) colW=Math.min(600, W - marginX*2);

    const leftX =stack?cx:(marginX + colW/2);
    const rightX=stack?cx:(W - marginX - colW/2);

    // tinggi panel: lebih kecil
    const panelH=Math.min(Math.round(H*0.42), 420);

    // MAP kiri
    let y=topPad+12;
    this.ui.mapLabel.setPosition(leftX, y);
    y += labelGap;
    this.ui.mapFrame.setSize(colW, panelH).setPosition(leftX, y + panelH/2);
    if(this.ui.mapImage.type==='Image'){
      const tex=this.ui.mapImage.texture.getSourceImage();
      const s=Math.min((colW-18)/tex.width,(panelH-18)/tex.height);
      this.ui.mapImage.setScale(s).setPosition(leftX, y + panelH/2);
    }else{
      this.ui.mapImage.setPosition(leftX, y + panelH/2);
    }
    const mapBottom = y + panelH;

    // CHAR kanan
    let y2 = stack? (mapBottom+28) : (topPad+12);
    this.ui.charLabel.setPosition(rightX, y2);
    y2 += labelGap;
    this.ui.charFrame.setSize(colW, panelH).setPosition(rightX, y2 + panelH/2);
    this.ui.charHL.setSize(colW+4, panelH+4).setPosition(rightX, y2 + panelH/2);

    const maxW=colW*0.76, maxH=panelH*0.76;
    if(this.ui.charIsSprite){
      const s=Math.min(maxW/128, maxH/128);
      this.ui.charImg.setScale(s).setPosition(rightX, y2 + panelH*0.5);
    }else{
      const tex=this.ui.charImg.texture.getSourceImage();
      const s=Math.min(maxW/tex.width, maxH/tex.height);
      this.ui.charImg.setScale(s).setPosition(rightX, y2 + panelH*0.5);
    }
    const charBottom = y2 + panelH;

    // Tombol SKATE (dipisah, tidak nempel)
    const contentBottom = stack ? Math.max(mapBottom, charBottom) : Math.max(mapBottom, charBottom);
    const btnY = Math.min(H - 70, contentBottom + btnGap);
    this.ui.startBtn.setPosition(cx, btnY);
    this.ui.startLbl.setPosition(cx, btnY);
  }
}

// ======= GAME (parallax city + basic runner) =======
class GameScene extends Phaser.Scene{
  constructor(){super('game')}
  create(){
    // Parallax 6 layer
    const speeds=[0.15,0.25,0.5,0.9,1.3,1.8];
    this.parallax=[];
    for(let i=1;i<=6;i++){
      const key='city'+i;
      const ts=this.add.tileSprite(0,0,GAME_WIDTH,GAME_HEIGHT,key).setOrigin(0,0);
      const img=this.textures.get(key).getSourceImage();
      if(img && (img.width||img.height)){
        const s=Math.max(GAME_WIDTH/img.width,GAME_HEIGHT/img.height);
        ts.setTileScale(s,s);
      }
      this.parallax.push({ts, speed:speeds[i-1]});
    }

    this.physics.world.setBounds(0,0,Number.MAX_SAFE_INTEGER/4,GAME_HEIGHT);
    this.groundY=GAME_HEIGHT-90;

    // Player
    this.player=this.physics.add.sprite(220,this.groundY-60,'skater',0).setScale(1.2);
    this.player.setCollideWorldBounds(true);
    this.anims.create({key:'idle',frames:[{key:'skater',frame:0}],frameRate:1,repeat:-1});
    this.anims.create({key:'run',frames:this.anims.generateFrameNumbers('skater',{start:1,end:4}),frameRate:12,repeat:-1});
    this.anims.create({key:'jump',frames:this.anims.generateFrameNumbers('skater',{start:5,end:7}),frameRate:10,repeat:0});
    this.anims.create({key:'crash',frames:[{key:'skater',frame:8}],frameRate:1,repeat:0});
    this.player.play('run');

    this.cursors=this.input.keyboard.createCursorKeys();
    this.score=0;
    this.scoreText=this.add.text(20,20,'Score: 0',{fontFamily:'system-ui',fontSize:24,color:'#fff'}).setScrollFactor(0);

    this.obstacles=this.physics.add.group();
    this.gems=this.physics.add.group();
    this.time.addEvent({delay:1200,loop:true,callback:()=>this.spawnObstacle(this.groundY)});
    this.time.addEvent({delay:900, loop:true,callback:()=>this.spawnGem(this.groundY)});
    this.physics.add.collider(this.player,this.obstacles,()=>this.onHit());

    this.player.on('animationcomplete',a=>{ if(a.key==='jump'&&this.player.body.onFloor()) this.player.play('run',true) });

    this.baseSpeed=260;
  }

  jump(){
    if(!this.player.body.onFloor()) return;
    this.player.setVelocityY(-520);
    this.player.play('jump',true);
  }

  update(){
    // forward feel + parallax
    this.player.setVelocityX(this.baseSpeed);
    this.parallax.forEach(l=> l.ts.tilePositionX += l.speed);

    if(Phaser.Input.Keyboard.JustDown(this.cursors.space)) this.jump();

    // overlap gems
    this.physics.overlap(this.player,this.gems,(p,g)=>{ g.destroy(); this.score+=10; this.scoreText.setText('Score: '+this.score); });
  }

  spawnObstacle(groundY){
    const high=Math.random()<0.5?false:true;
    const y=high?(groundY-90):(groundY-40);
    const w=high?140:50, h=high?30:60;
    const color=high?0xE3C833:0xD94848;
    const x=GAME_WIDTH+80;
    const r=this.add.rectangle(x,y,w,h,color).setOrigin(0.5);
    this.physics.add.existing(r); r.body.setVelocityX(-this.baseSpeed).setAllowGravity(false);
    this.obstacles.add(r);
  }

  spawnGem(groundY){
    const y=groundY-120-Math.random()*120;
    const x=GAME_WIDTH+80;
    const c=this.add.circle(x,y,12,0x35e1a1); this.physics.add.existing(c);
    c.body.setVelocityX(-this.baseSpeed).setAllowGravity(false);
    this.gems.add(c);
  }

  onHit(){
    if(this.gameOver) return; this.gameOver=true;
    this.player.play('crash',true); this.player.setVelocity(0);
    this.time.delayedCall(900,()=> this.scene.start('gameover',{score:this.score}));
  }
}

// ======= GAME OVER =======
class GameOverScene extends Phaser.Scene{
  constructor(){super('gameover')}
  init(d){ this.finalScore=d.score||0 }
  create(){
    const cx=GAME_WIDTH/2, cy=GAME_HEIGHT/2;
    this.cameras.main.setBackgroundColor('#101010');
    this.add.text(cx,cy-120,'Game Over',{fontFamily:'system-ui',fontSize:54,color:'#fff',fontStyle:'bold'}).setOrigin(0.5);
    this.add.text(cx,cy-60,`Score: ${this.finalScore}`,{fontFamily:'system-ui',fontSize:28,color:'#fff'}).setOrigin(0.5);

    const raw=prompt('Masukkan nama untuk leaderboard:',localStorage.getItem('rr_name')||'player');
    const name=(raw||'player').slice(0,14); localStorage.setItem('rr_name',name);
    const rows=Leaderboard.push(name,this.finalScore);

    this.add.text(cx,cy+10,'Leaderboard (Local)',{fontFamily:'system-ui',fontSize:22,color:'#a7a7a7'}).setOrigin(0.5);
    const startY=cy+40;
    rows.slice(0,10).forEach((r,i)=>{
      const y=startY+i*26, hi=(r.name===name && r.score===this.finalScore), color=hi?'#35e1a1':'#ffffff';
      this.add.text(cx-140,y,String(i+1).padStart(2,'0'),{fontFamily:'monospace',fontSize:18,color}).setOrigin(0,0.5);
      this.add.text(cx-90, y, r.name.slice(0,14),{fontFamily:'system-ui',fontSize:18,color}).setOrigin(0,0.5);
      this.add.text(cx+160,y,String(r.score),{fontFamily:'system-ui',fontSize:18,color}).setOrigin(1,0.5);
    });

    const again=this.add.rectangle(cx-120,GAME_HEIGHT-80,220,56,0x35e1a1).setInteractive({useHandCursor:true});
    this.add.text(again.x,again.y,'PLAY AGAIN',{fontFamily:'system-ui',fontSize:20,color:'#111',fontStyle:'bold'}).setOrigin(0.5);
    again.on('pointerup',()=>this.scene.start('game'));

    const menu=this.add.rectangle(cx+120,GAME_HEIGHT-80,220,56,0xFFC62E).setInteractive({useHandCursor:true});
    this.add.text(menu.x,menu.y,'MAIN MENU',{fontFamily:'system-ui',fontSize:20,color:'#111',fontStyle:'bold'}).setOrigin(0.5);
    menu.on('pointerup',()=>this.scene.start('menu'));

    const reset=this.add.text(34,GAME_HEIGHT-50,'Reset Leaderboard',{fontFamily:'system-ui',fontSize:16,color:'#aaa'}).setInteractive({useHandCursor:true});
    reset.on('pointerup',()=>{ localStorage.removeItem(STORAGE_KEY); this.scene.restart({score:this.finalScore}); });
  }
}

// ======= PHASER CONFIG =======
new Phaser.Game({
  type: Phaser.AUTO,
  parent:'game-root',
  backgroundColor:'#000',
  scale:{ mode:Phaser.Scale.FIT, autoCenter:Phaser.Scale.CENTER_BOTH, width:GAME_WIDTH, height:GAME_HEIGHT },
  physics:{ default:'arcade', arcade:{ gravity:{y:1200}, debug:false } },
  scene:[BootScene,SplashScene,MenuScene,GameScene,GameOverScene]
});
</script>
</body>
</html>
